# 배포하기

1. 우선, 프로젝트를 배포할 서버를 준비합니다. 서버는 반드시 64bit 환경을 사용해야 합니다.
    *※ MongoDB는 32bit 컴퓨터에서는 심각한 제한이 있습니다. 32bit 컴퓨터가 다룰 수 있는 크기가 최대 4gb 이기 때문입니다.*

2. 프로젝트를 배포할 서버가 준비되면, 서버에 [설치하기](INSTALL.md) 문서를 참고하여 필요한 기반 시스템을 모두 설치합니다.

3. 프로젝트 폴더를 생성합니다.

4. 생성한 폴더에 패키징 된 프로젝트와 **V 파일**을 복사합니다. 프로젝트 패키징은 [패키징](PACK.md) 문서를 참고해주시기 바랍니다.

3. 프로젝트 실행을 위한 코드를 배포 서버의 설정에 맞게 작성합니다.

4. 프로젝트를 실행하고, 접속이 잘 되는지 등 테스트를 수행합니다.
```
node {{프로젝트 명.js}}
```

5. 프로젝트 실행에 문제가 없으면 `Ctrl + C`를 눌러 프로젝트를 종료하고, `forever` 등으로 프로젝트를 데몬 형태로 실행합니다.
```
forever start {{프로젝트 명.js}}
```

6. 프로젝트 실행에 문제가 있다면 문제를 해결한 후, 4번 과정부터 다시 수행합니다. 이 때, **V 파일**을 업데이트 하여야 변경된 사항이 반영됩니다. 

## 주의사항
* DB의 update명령어가 동시에 여러번 호출 될 경우 모든 update는 같은 데이터(수정된)를 반환합니다.
* find 명령을 수행할 때, filter의 모든 property가 `undefined`로만 이루어진 경우에는 모든 값을 대상으로 검색합니다. 이는 `filter : {}`와 같기 때문입니다. 이를 방지하려면, `if (CHECK_ARE_SAME([{}, filter]) === true) {...}`로 filter가 비어있는지 확인하시기 바랍니다.
* 배포시에는 보안을 위해 MongoDB를 인증 모드로 실행해주시기 바랍니다.

## MongoDB 유저 추가
인증 모드로 MongoDB를 실행한 후 데이터베이스에 접근하기 위해서는 해당 데이터베이스에 유저가 존재해야 합니다. 유저를 추가하기 위한 방법은 다음과 같습니다.

1. 우선 관리자로 접근합니다.
	```javascript
	use admin
	db.auth('root 유저명', 'root 비밀번호')
	```
	
	* 만약 관리자 계정이 없다면 생성합니다.
	```javascript
	use admin
	db.createUser({ user : 'root 유저명', pwd : 'root 비밀번호', roles : ['root'] })
	```

2. 데이터베이스에 유저를 생성합니다.
	```javascript
	use DB명
	db.createUser({ user : '유저명', pwd : '비밀번호', roles : ['readWrite', 'dbAdmin'] })
	```

3. 다음과 같이 프로젝트 실행을 위한 설정 파일(프로젝트 명.js)에 MongoDB 접속에 필요한 `유저명`과 `비밀번호`를 추가합니다.
	```javascript
	require(process.env.UPPERCASE_IO_PATH + '/BOOT.js');
	
	BOOT({
		CONFIG : {
	        isDevMode : true,
			defaultBoxName : 'Sample',
	        title : 'Sample',
			webServerPort : 8888
		},
		NODE_CONFIG : {
		    // 데이터베이스 설정
			// 데이터베이스 이름은 Sample 입니다.
			dbName : 'Sample',
			// 데이터베이스 접속 username은 test입니다.
			dbUsername : 'test',
			// 데이터베이스 접속 password는 1234입니다.
			dbPassword : '1234'
		}
	});
	```

## V 파일
**프로젝트 폴더 내의 V 파일은 매우 중요합니다.**

V 파일은 버젼 넘버를 저장하고 있는 파일로써, 이를 기반으로 캐싱이 수행됩니다.

* 프로젝트를 업데이트 할 때는 V 파일의 숫자를 증가시켜주시기 바랍니다. 그래야 캐싱이 새롭게 반영됩니다.
* 버전 정보를 담고 있는 V 파일을 배포시 잘 설정해주시기 바랍니다. 만약 분산 서버가 구성되어 있다면 모든 서버의 V 파일이 동일해야합니다.
* Git 등의 소스코드 버젼 관리 시에는 .gitignore 등의 설정으로 V 파일을 제외시킵니다.

## 설정 파일에 설정하기 (프로젝트 명.js)
**추후 프로젝트 업데이트 시 실수로 개발 환경의 설정 파일을 덮어씌우지 마세요. 필요한 변경 사항만 수정해주시기 바랍니다.**

## 서버 이전하기
1. 기존 프로젝트를 중단합니다. 만약 `forever`를 사용한다면 다음과 같이 입력합니다.
```
forever stop {{프로젝트 명.js}}
```

2. 기존 서버에서 프로젝트를 압축하여 백업합니다.
```
zip -r {{프로젝트 폴더 명.zip}} {{프로젝트 폴더 명}}
```

3. 기존 서버에서 데이터베이스를 백업합니다.
```
mongodump -d {{데이터베이스 이름}} -u {{데이터베이스 접속 username}} -p {{데이터베이스 접속 password}}
```

4. 이전 할 서버에 [UPPERCASE를 세팅](INSTALL.md)합니다.

5. 이전 할 서버에 백업한 프로젝트의 압축을 풉니다.
```
unzip {{프로젝트 폴더 명.zip}}
```

6. 데이터베이스에 유저 정보를 생성합니다.
상단의 `MongoDB 유저 추가` 부분을 참고하여 유저 정보를 생성합니다.

7. 이전 할 서버에서 데이터베이스를 복구합니다.
```
mongorestore dump/{{프로젝트 폴더 명}} -d {{데이터베이스 이름}} -u {{데이터베이스 접속 username}} -p {{데이터베이스 접속 password}}
```

8. 프로젝트를 실행합니다. 만약 `forever`를 사용한다면 다음과 같이 입력합니다.
```
cd {{프로젝트 폴더 명}}
forever start {{프로젝트 명.js}}
```

다음 문서: [UPPERCASE 업데이트](UPDATE.md)
